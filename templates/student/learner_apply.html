{% extends "base/signup_base.html" %}
{% load widget_tweaks %}

{% block title %}New Learner Application{% endblock %}

{% block content %}
<div x-data="{ step: 1, total: 2 }"
     class="bg-white p-8 rounded-2xl shadow-lg fade-in max-w-3xl mx-auto">
  <h1 class="text-3xl font-semibold mb-6 text-gray-800">
    New Learner Application
  </h1>

  <!-- Progress Bar -->
  <div class="w-full bg-gray-200 rounded-full h-2 mb-6">
    <div class="bg-blue-600 h-2 rounded-full transition-all"
         :style="`width: ${(step/total)*100}%`"></div>
  </div>

  <!-- Step Indicators -->
  <div class="flex justify-between mb-8">
    <template x-for="i in total" :key="i">
      <div class="flex flex-col items-center space-y-1">
        <div 
          x-bind:class="step===i 
            ? 'bg-blue-600 text-white' 
            : 'bg-gray-200 text-gray-500'"
          class="w-10 h-10 flex items-center justify-center rounded-full transition-colors">
          <span x-text="i"></span>
        </div>
        <span class="text-gray-600 text-sm"
              x-text="['Personal Info','POPI Consent'][i-1]"></span>
      </div>
    </template>
  </div>

  <form 
    x-ref="learnerForm"
    method="post" 
    action=""
    @submit.prevent="
      if (step < total) {
        step++
      } else {
        $refs.learnerForm.submit()
      }
    "
    class="space-y-6"
  >
    {% csrf_token %}

    {# hidden fields #}
    {% for hidden in form.hidden_fields %}
      {{ hidden }}
    {% endfor %}

    {# non-field errors #}
    {% if form.non_field_errors %}
      <div class="p-4 mb-4 bg-red-50 border border-red-200 rounded">
        {% for err in form.non_field_errors %}
          <p class="text-red-700 flex items-center">
            <i data-feather="alert-circle" class="w-5 h-5 mr-2"></i>{{ err }}
          </p>
        {% endfor %}
      </div>
    {% endif %}

    <!-- STEP 1: Personal & Contact -->
    <fieldset x-show="step===1" x-transition class="space-y-4">
      <!-- First / Last / Email -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-700 mb-1">First Name</label>
          {{ form.first_name|add_class:"border border-gray-300 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" }}
          {% for err in form.first_name.errors %}
            <p class="mt-1 text-sm text-red-600">{{ err }}</p>
          {% endfor %}
        </div>
        <div>
          <label class="block text-gray-700 mb-1">Last Name</label>
          {{ form.last_name|add_class:"border border-gray-300 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" }}
          {% for err in form.last_name.errors %}
            <p class="mt-1 text-sm text-red-600">{{ err }}</p>
          {% endfor %}
        </div>
      </div>
      <div>
        <label class="block text-gray-700 mb-1">Email Address</label>
        {{ form.email|add_class:"border border-gray-300 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" }}
        {% for err in form.email.errors %}
          <p class="mt-1 text-sm text-red-600">{{ err }}</p>
        {% endfor %}
      </div>

      <!-- ID, DOB, Gender -->
      <div class="grid grid-cols-3 gap-4">
        <div>
          <label class="block text-gray-700 mb-1">ID Number</label>
          {{ form.id_number|add_class:"border border-gray-300 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" }}
          {% for err in form.id_number.errors %}
            <p class="mt-1 text-sm text-red-600">{{ err }}</p>
          {% endfor %}
        </div>
        <div>
          <label class="block text-gray-700 mb-1">Date of Birth</label>
          {{ form.date_of_birth|add_class:"border border-gray-300 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" }}
          {% for err in form.date_of_birth.errors %}
            <p class="mt-1 text-sm text-red-600">{{ err }}</p>
          {% endfor %}
        </div>
        <div>
          <label class="block text-gray-700 mb-1">Gender</label>
          {{ form.gender|add_class:"border border-gray-300 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" }}
          {% for err in form.gender.errors %}
            <p class="mt-1 text-sm text-red-600">{{ err }}</p>
          {% endfor %}
        </div>
      </div>

      <!-- Phone & Address -->
      <div>
        <label class="block text-gray-700 mb-1">Phone</label>
        {{ form.phone|add_class:"border border-gray-300 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" }}
        {% for err in form.phone.errors %}
          <p class="mt-1 text-sm text-red-600">{{ err }}</p>
        {% endfor %}
      </div>
      <div>
        <label class="block text-gray-700 mb-1">Address</label>
        {{ form.address|add_class:"border border-gray-300 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" }}
        {% for err in form.address.errors %}
          <p class="mt-1 text-sm text-red-600">{{ err }}</p>
        {% endfor %}
      </div>

      <!-- Nationality & Language -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-700 mb-1">Nationality</label>
          {{ form.nationality|add_class:"border border-gray-300 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" }}
          {% for err in form.nationality.errors %}
            <p class="mt-1 text-sm text-red-600">{{ err }}</p>
          {% endfor %}
        </div>
        <div>
          <label class="block text-gray-700 mb-1">Primary Language</label>
          {{ form.primary_language|add_class:"border border-gray-300 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" }}
          {% for err in form.primary_language.errors %}
            <p class="mt-1 text-sm text-red-600">{{ err }}</p>
          {% endfor %}
        </div>
      </div>

      <!-- Emergency Contact -->
      <h3 class="font-semibold text-gray-800 mt-4">Emergency Contact</h3>
      <div>
        <label class="block text-gray-700 mb-1">Name</label>
        {{ form.emergency_name|add_class:"border border-gray-300 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" }}
        {% for err in form.emergency_name.errors %}
          <p class="mt-1 text-sm text-red-600">{{ err }}</p>
        {% endfor %}
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-700 mb-1">Relation</label>
          {{ form.emergency_relation|add_class:"border border-gray-300 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" }}
          {% for err in form.emergency_relation.errors %}
            <p class="mt-1 text-sm text-red-600">{{ err }}</p>
          {% endfor %}
        </div>
        <div>
          <label class="block text-gray-700 mb-1">Phone</label>
          {{ form.emergency_phone|add_class:"border border-gray-300 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" }}
          {% for err in form.emergency_phone.errors %}
            <p class="mt-1 text-sm text-red-600">{{ err }}</p>
          {% endfor %}
        </div>
      </div>
    </fieldset>

    <!-- STEP 2: POPI Act consent -->
    <fieldset x-show="step===2" x-transition class="space-y-4">
      <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
        <p class="text-yellow-800">
          By submitting this form you agree that we may collect and process your personal data
          in accordance with the Protection of Personal Information Act (POPI).
        </p>
      </div>
      <div>
        {{ form.popi_consent|add_class:"form-checkbox h-5 w-5 text-blue-600" }}
        <label class="ml-2 text-gray-700">{{ form.popi_consent.label }}</label>
        {% for err in form.popi_consent.errors %}
          <p class="mt-1 text-sm text-red-600 flex items-center">
            <i data-feather="alert-circle" class="w-4 h-4 mr-1"></i> {{ err }}
          </p>
        {% endfor %}
      </div>
    </fieldset>

    <!-- NAVIGATION BUTTONS -->
    <div class="flex justify-between items-center mt-8">
      <button type="button" @click="step--" x-show="step>1"
              class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">
        Previous
      </button>
      <button type="button" @click="step++" x-show="step<total"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
        Next
      </button>
      <button type="submit" x-show="step===total"
              class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition inline-flex items-center">
        <i data-feather="send" class="w-5 h-5 mr-2"></i>Submit Application
      </button>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script src="https://unpkg.com/feather-icons"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    feather.replace();
  });
</script>
{% endblock %}

{% extends "base/base.html" %}
{% load crispy_forms_tags %}

{% block title %}{{ page_title }} - {{ block.super }}{% endblock %}

{% block content %}

    <!-- Main Content -->
    <div class="">
        <main class="flex-1 pt-16">
            <div class="py-6">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    
                    <!-- Page Header -->
                    <div class="mb-8">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-900">{{ page_title }}</h1>
                                <p class="mt-2 text-sm text-gray-600">Showing {{ total_count }} applications across all councils</p>
                            </div>
                            <div class="flex space-x-3">
                                {% if can_export_data %}
                                <!-- Professional Export Dropdown -->
                                <div class="relative" id="exportDropdown">
                                    <button 
                                        onclick="toggleExportDropdown()" 
                                        class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                    >
                                        <i class="bi bi-download mr-2"></i>
                                        Export
                                        <i class="bi bi-chevron-down ml-2"></i>
                                    </button>
                                    <div id="exportMenu" class="hidden absolute right-0 z-10 mt-2 w-72 bg-white rounded-md shadow-lg border border-gray-200">
                                        <div class="py-2">
                                            <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wide border-b border-gray-100">
                                                Excel Export Options
                                            </div>
                                            
                                            <!-- Summary Export -->
                                            <button onclick="exportApplications('summary')" class="w-full text-left block px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                                <div class="flex items-start">
                                                    <i class="bi bi-bar-chart text-blue-500 mt-0.5 mr-3"></i>
                                                    <div>
                                                        <div class="font-medium">Executive Summary</div>
                                                        <div class="text-xs text-gray-500">High-level statistics and overview</div>
                                                    </div>
                                                </div>
                                            </button>
                                            
                                            <!-- Detailed Export -->
                                            <button onclick="exportApplications('detailed')" class="w-full text-left block px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                                <div class="flex items-start">
                                                    <i class="bi bi-table text-green-500 mt-0.5 mr-3"></i>
                                                    <div>
                                                        <div class="font-medium">Detailed Report</div>
                                                        <div class="text-xs text-gray-500">Complete application information</div>
                                                    </div>
                                                </div>
                                            </button>
                                            
                                            <!-- Council Breakdown -->
                                            <button onclick="exportApplications('council_breakdown')" class="w-full text-left block px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                                <div class="flex items-start">
                                                    <i class="bi bi-building text-purple-500 mt-0.5 mr-3"></i>
                                                    <div>
                                                        <div class="font-medium">Council Breakdown</div>
                                                        <div class="text-xs text-gray-500">Applications grouped by council</div>
                                                    </div>
                                                </div>
                                            </button>
                                            
                                            <!-- Status Report -->
                                            <button onclick="exportApplications('status_report')" class="w-full text-left block px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                                <div class="flex items-start">
                                                    <i class="bi bi-clipboard-check text-orange-500 mt-0.5 mr-3"></i>
                                                    <div>
                                                        <div class="font-medium">Status Report</div>
                                                        <div class="text-xs text-gray-500">Applications grouped by status</div>
                                                    </div>
                                                </div>
                                            </button>
                                            
                                            <!-- Timeline Report -->
                                            <button onclick="exportApplications('timeline')" class="w-full text-left block px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                                <div class="flex items-start">
                                                    <i class="bi bi-clock-history text-indigo-500 mt-0.5 mr-3"></i>
                                                    <div>
                                                        <div class="font-medium">Timeline Analysis</div>
                                                        <div class="text-xs text-gray-500">Applications with submission timeline</div>
                                                    </div>
                                                </div>
                                            </button>
                                            
                                            <!-- Contact List -->
                                            <button onclick="exportApplications('contact_list')" class="w-full text-left block px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-colors border-t border-gray-100">
                                                <div class="flex items-start">
                                                    <i class="bi bi-person-lines-fill text-cyan-500 mt-0.5 mr-3"></i>
                                                    <div>
                                                        <div class="font-medium">Contact List</div>
                                                        <div class="text-xs text-gray-500">Contact information only</div>
                                                    </div>
                                                </div>
                                            </button>
                                            
                                            <!-- Note about filters -->
                                            <div class="px-4 py-2 text-xs text-gray-500 bg-blue-50 border-t border-gray-100">
                                                <i class="bi bi-info-circle mr-1"></i>
                                                Exports will include current filter settings
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                <a href="{% url 'enrollments:onboarding_start' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                    <i class="bi bi-plus mr-2"></i>
                                    New Application
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-6">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                                            <i class="bi bi-file-earmark-text text-white"></i>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Total Applications</dt>
                                            <dd class="text-2xl font-semibold text-gray-900">{{ total_count }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-6">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                                            <i class="bi bi-check-circle text-white"></i>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Approved</dt>
                                            <dd class="text-2xl font-semibold text-gray-900">{{ status_counts.approved|default:0 }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-6">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                                            <i class="bi bi-clock text-white"></i>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Under Review</dt>
                                            <dd class="text-2xl font-semibold text-gray-900">{{ status_counts.under_review|default:0 }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-6">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-red-500 rounded-md flex items-center justify-center">
                                            <i class="bi bi-x-circle text-white"></i>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Rejected</dt>
                                            <dd class="text-2xl font-semibold text-gray-900">{{ status_counts.rejected|default:0 }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Rest of your existing template stays the same -->
                    <!-- Filters and Search -->
                    <div class="bg-white shadow rounded-lg mb-8">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">Filters & Search</h3>
                        </div>
                        <div class="px-6 py-4">
                            <form method="get" class="space-y-4" id="filterForm">
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <!-- Search Query -->
                                    <div>
                                        <label for="search_query" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                                        <input 
                                            type="text" 
                                            name="search_query" 
                                            id="search_query"
                                            value="{{ current_filters.search_query|default:'' }}"
                                            placeholder="Name, email, or application number..."
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                        >
                                    </div>
                                    
                                    <!-- Council Filter -->
                                    <div>
                                        <label for="council" class="block text-sm font-medium text-gray-700 mb-1">Council</label>
                                        <select name="council" id="council" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">All Councils</option>
                                            {% for council in councils %}
                                            <option value="{{ council.id }}" {% if council.id == current_filters.council.id %}selected{% endif %}>
                                                {{ council.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <!-- Status Filter -->
                                    <div>
                                        <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                        <select name="status" id="status" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">All Statuses</option>
                                            {% for status_key, status_label in status_choices %}
                                            <option value="{{ status_key }}" {% if status_key == current_filters.status %}selected{% endif %}>
                                                {{ status_label }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <!-- Application Type Filter -->
                                    <div>
                                        <label for="app_type" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                                        <select name="app_type" id="app_type" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">All Types</option>
                                            {% for type_key, type_label in app_type_choices %}
                                            <option value="{{ type_key }}" {% if type_key == current_filters.app_type %}selected{% endif %}>
                                                {{ type_label }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Date Range -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="date_from" class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                                        <input 
                                            type="date" 
                                            name="date_from" 
                                            id="date_from"
                                            value="{{ current_filters.date_from|date:'Y-m-d' }}"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                        >
                                    </div>
                                    <div>
                                        <label for="date_to" class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                                        <input 
                                            type="date" 
                                            name="date_to" 
                                            id="date_to"
                                            value="{{ current_filters.date_to|date:'Y-m-d' }}"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                        >
                                    </div>
                                </div>
                                
                                <!-- Filter Actions -->
                                <div class="flex space-x-3">
                                    <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                        <i class="bi bi-search mr-2"></i>
                                        Apply Filters
                                    </button>
                                    <a href="{% url 'enrollments:application_list' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                        <i class="bi bi-x-circle mr-2"></i>
                                        Clear Filters
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Rest of your existing applications table and content... -->
                    <!-- Applications Table -->
                    <div class="bg-white shadow rounded-lg mb-8">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-medium text-gray-900">Applications</h3>
                                <div class="text-sm text-gray-500">
                                    Showing {{ page_info.start_index }}-{{ page_info.end_index }} of {{ total_count }} results
                                </div>
                            </div>
                        </div>
                        <div class="px-6 py-4">
                            {% if applications %}
                            <div class="space-y-3">
                                {% for application in applications %}
                                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-3 mb-2">
                                                <!-- Council Badge -->
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                                    {% if application.council == 'CGMP' %}bg-blue-100 text-blue-800
                                                    {% elif application.council == 'CPSC' %}bg-green-100 text-green-800
                                                    {% else %}bg-cyan-100 text-cyan-800{% endif %}">
                                                    {{ application.council }}
                                                </span>
                                                
                                                <!-- Application Type Badge -->
                                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium 
                                                    {% if application.type == 'Associated' %}bg-purple-100 text-purple-800
                                                    {% elif application.type == 'Designated' %}bg-indigo-100 text-indigo-800
                                                    {% else %}bg-orange-100 text-orange-800{% endif %}">
                                                    {{ application.type }}
                                                </span>
                                                
                                                <!-- Applicant Name -->
                                                <h4 class="text-sm font-medium text-gray-900">{{ application.name }}</h4>
                                                
                                                <!-- Status Badge -->
                                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium 
                                                    {% if application.status == 'approved' %}bg-green-100 text-green-800
                                                    {% elif application.status == 'pending' or application.status == 'submitted' %}bg-yellow-100 text-yellow-800
                                                    {% elif application.status == 'under_review' %}bg-blue-100 text-blue-800
                                                    {% elif application.status == 'rejected' %}bg-red-100 text-red-800
                                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                    {% if application.status == 'approved' %}
                                                        Approved
                                                    {% elif application.status == 'pending' or application.status == 'submitted' %}
                                                        Pending
                                                    {% elif application.status == 'under_review' %}
                                                        Under Review
                                                    {% elif application.status == 'rejected' %}
                                                        Rejected
                                                    {% else %}
                                                        {{ application.status|title }}
                                                    {% endif %}
                                                </span>
                                            </div>
                                            
                                            <!-- Application Details -->
                                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm text-gray-500">
                                                <span class="flex items-center">
                                                    <i class="bi bi-envelope mr-1"></i>
                                                    {{ application.email }}
                                                </span>
                                                <span class="flex items-center">
                                                    <i class="bi bi-hash mr-1"></i>
                                                    {{ application.application_number|default:"N/A" }}
                                                </span>
                                                <span class="flex items-center">
                                                    <i class="bi bi-clock mr-1"></i>
                                                    {{ application.created_at|timesince }} ago
                                                </span>
                                                {% if application.extra_info %}
                                                <span class="flex items-center">
                                                    <i class="bi bi-info-circle mr-1"></i>
                                                    {{ application.extra_info }}
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Action Buttons -->
                                        <div class="flex items-center space-x-2">
                                            <a href="{% url 'enrollments:application_detail' pk=application.id app_type=application.app_type %}" 
                                               class="inline-flex items-center px-3 py-1 border border-transparent text-sm leading-4 font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 transition-colors">
                                                <i class="bi bi-eye mr-1"></i>
                                                View
                                            </a>
                                            
                                            <!-- Actions Dropdown -->
                                            <div class="relative">
                                                <button class="inline-flex items-center px-2 py-1 border border-gray-300 text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors" onclick="toggleDropdown(this)">
                                                    <i class="bi bi-three-dots"></i>
                                                </button>
                                                <div class="hidden absolute right-0 z-10 mt-2 w-48 bg-white rounded-md shadow-lg border border-gray-200">
                                                    <div class="py-1">
                                                        <a href="{% url 'enrollments:application_update' pk=application.id app_type=application.app_type %}" 
                                                           class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                                            <i class="bi bi-pencil mr-2"></i>Edit
                                                        </a>
                                                        {% if can_approve_applications %}
                                                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                                            <i class="bi bi-check-circle mr-2"></i>Review
                                                        </a>
                                                        {% endif %}
                                                        <div class="border-t border-gray-100"></div>
                                                        {% if can_delete_applications %}
                                                        <a href="{% url 'enrollments:application_delete' pk=application.id app_type=application.app_type %}" 
                                                           class="block px-4 py-2 text-sm text-red-700 hover:bg-red-50 transition-colors">
                                                            <i class="bi bi-trash mr-2"></i>Delete
                                                        </a>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-12">
                                <i class="bi bi-inbox text-gray-400 text-6xl mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">No Applications Found</h3>
                                <p class="text-sm text-gray-500 mb-4">
                                    {% if current_filters.search_query or current_filters.council or current_filters.status %}
                                        Try adjusting your filters to see more results.
                                    {% else %}
                                        No applications have been submitted yet.
                                    {% endif %}
                                </p>
                                <a href="{% url 'enrollments:onboarding_start' %}" 
                                   class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                    <i class="bi bi-plus mr-2"></i>
                                    Create New Application
                                </a>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Pagination -->
                        {% if applications and page_info.total_pages > 1 %}
                        <div class="px-6 py-4 border-t border-gray-200">
                            <div class="flex items-center justify-between">
                                <div class="text-sm text-gray-500">
                                    Page {{ page_info.current_page }} of {{ page_info.total_pages }}
                                </div>
                                <div class="flex space-x-2">
                                    {% if page_info.has_previous %}
                                    <a href="?page={{ applications.previous_page_number }}" 
                                       class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                        <i class="bi bi-chevron-left mr-1"></i>
                                        Previous
                                    </a>
                                    {% endif %}
                                    
                                    {% if page_info.has_next %}
                                    <a href="?page={{ applications.next_page_number }}" 
                                       class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                        Next
                                        <i class="bi bi-chevron-right ml-1"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Export dropdown functionality
        function toggleExportDropdown() {
            const menu = document.getElementById('exportMenu');
            menu.classList.toggle('hidden');
        }

        // Close export dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('exportDropdown');
            const menu = document.getElementById('exportMenu');
            
            if (!dropdown.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });

        // Export applications with format and current filters
        function exportApplications(format) {
            // Get current filter values
            const formData = new FormData(document.getElementById('filterForm'));
            const params = new URLSearchParams(formData);
            params.append('format', format);
            
            // Show loading state
            showAlert('Preparing ' + format.replace('_', ' ') + ' export...', 'info');
            
            // Create export URL with filters
            const exportUrl = '{% url "enrollments:export_applications" %}?' + params.toString();
            
            // Close dropdown
            document.getElementById('exportMenu').classList.add('hidden');
            
            // Trigger download
            window.location.href = exportUrl;
            
            // Show success message after delay
            setTimeout(() => {
                showAlert('Export completed successfully!', 'success');
            }, 2000);
        }

        // Toggle sidebar on mobile
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('open');
        }

        // Toggle submenu
        function toggleSubmenu(menuId) {
            const submenu = document.getElementById(menuId + '-submenu');
            const icon = document.getElementById(menuId + '-icon');
            
            submenu.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
        }

        // Toggle dropdown
        function toggleDropdown(button) {
            const dropdown = button.nextElementSibling;
            
            // Close all other dropdowns
            document.querySelectorAll('.relative .absolute').forEach(d => {
                if (d !== dropdown) d.classList.add('hidden');
            });
            
            dropdown.classList.toggle('hidden');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.relative')) {
                document.querySelectorAll('.relative .absolute').forEach(d => {
                    d.classList.add('hidden');
                });
            }
        });

        // Show alert
        function showAlert(message, type) {
            const colors = {
                success: 'bg-green-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500',
                error: 'bg-red-500'
            };
            
            const alert = document.createElement('div');
            alert.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
            alert.innerHTML = `<i class="bi bi-check-circle mr-2"></i>${message}`;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.querySelector('.sidebar');
            const menuButton = document.querySelector('button[onclick="toggleSidebar()"]');
            
            if (window.innerWidth < 768 && sidebar.classList.contains('open')) {
                if (!sidebar.contains(event.target) && !menuButton.contains(event.target)) {
                    sidebar.classList.remove('open');
                }
            }
        });
    </script>

{% endblock %}
{% extends "base/enrollment_base.html" %}

{% block title %}All Applications - ACRP{% endblock %}

{% block breadcrumb %}Applications / All Applications{% endblock %}

{% block content %}
<div class="py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Page Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">All Applications</h1>
                    <p class="mt-2 text-sm text-gray-600">Manage and review all enrollment applications</p>
                </div>
                <div class="flex space-x-3">
                    <button class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                        <i class="bi bi-download mr-2"></i>
                        Export Applications
                    </button>
                    <a href="{% url 'enrollments:onboarding_start' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        <i class="bi bi-plus mr-2"></i>
                        New Application
                    </a>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Filter Applications</h3>
            </div>
            <div class="px-6 py-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Council</label>
                        <select class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" onchange="filterApplications()">
                            <option value="">All Councils</option>
                            <option value="cgmp">CGMP</option>
                            <option value="cpsc">CPSC</option>
                            <option value="cmtp">CMTP</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" onchange="filterApplications()">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="under_review">Under Review</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                        <select class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" onchange="filterApplications()">
                            <option value="">All Types</option>
                            <option value="associated">Associated</option>
                            <option value="designated">Designated</option>
                            <option value="student">Student</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                        <div class="relative">
                            <input type="text" placeholder="Search applications..." class="block w-full px-3 py-2 pl-10 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" onkeyup="searchApplications()">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="bi bi-search text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 flex justify-between items-center">
                    <div class="text-sm text-gray-500">
                        Showing <span id="showing-count">{{ applications|length }}</span> of <span id="total-count">{{ total_count }}</span> applications
                    </div>
                    <button onclick="clearFilters()" class="text-sm text-blue-600 hover:text-blue-500">Clear all filters</button>
                </div>
            </div>
        </div>

        <!-- Applications Table -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-medium text-gray-900">Applications</h3>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-500">View:</span>
                        <button class="px-3 py-1 text-sm bg-blue-500 text-white rounded-md" onclick="setView('list')">List</button>
                        <button class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded-md" onclick="setView('card')">Cards</button>
                    </div>
                </div>
            </div>
            
            <!-- List View -->
            <div id="list-view" class="overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <input type="checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" onchange="toggleSelectAll()">
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Applicant</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Council</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submitted</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for application in applications %}
                        <tr class="hover:bg-gray-50 application-row" data-council="{{ application.council|lower }}" data-status="{{ application.status }}" data-type="{{ application.type|lower }}">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input type="checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" value="{{ application.id }}">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900">{{ application.name }}</div>
                                        <div class="text-sm text-gray-500">{{ application.email }}</div>
                                        <div class="text-xs text-gray-400">{{ application.application_number }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if application.council == 'CGMP' %}bg-blue-100 text-blue-800{% elif application.council == 'CPSC' %}bg-green-100 text-green-800{% else %}bg-cyan-100 text-cyan-800{% endif %}">
                                    {{ application.council }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium {% if application.type == 'Associated' %}bg-purple-100 text-purple-800{% elif application.type == 'Designated' %}bg-indigo-100 text-indigo-800{% else %}bg-orange-100 text-orange-800{% endif %}">
                                    {{ application.type }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium {% if application.status == 'approved' %}bg-green-100 text-green-800{% elif application.status == 'pending' or application.status == 'submitted' %}bg-yellow-100 text-yellow-800{% elif application.status == 'under_review' %}bg-blue-100 text-blue-800{% else %}bg-red-100 text-red-800{% endif %}">
                                    {% if application.status == 'approved' %}
                                        Approved
                                    {% elif application.status == 'pending' or application.status == 'submitted' %}
                                        Pending
                                    {% elif application.status == 'under_review' %}
                                        Under Review
                                    {% elif application.status == 'rejected' %}
                                        Rejected
                                    {% else %}
                                        {{ application.status|title }}
                                    {% endif %}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ application.created_at|date:"M d, Y" }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <div class="flex items-center space-x-2">
                                    {% if application.type and application.id %}
                                    <a href="{% url 'enrollments:application_detail' pk=application.id app_type=application.type|lower %}" class="text-blue-600 hover:text-blue-900">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{% url 'enrollments:application_update' pk=application.id app_type=application.type|lower %}" class="text-indigo-600 hover:text-indigo-900">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    {% endif %}
                                    <button onclick="deleteApplication({{ application.id }}, '{{ application.type|lower }}')" class="text-red-600 hover:text-red-900">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="px-6 py-12 text-center">
                                <div class="text-gray-400">
                                    <i class="bi bi-inbox text-4xl mb-4"></i>
                                    <h3 class="text-lg font-medium text-gray-900 mb-2">No Applications Found</h3>
                                    <p class="text-sm">No applications match your current filters.</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Bulk Actions -->
            <div class="px-6 py-3 border-t border-gray-200 bg-gray-50" id="bulk-actions" style="display: none;">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        <span id="selected-count">0</span> applications selected
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="bulkAction('approve')" class="px-3 py-1 bg-green-600 text-white text-sm rounded-md hover:bg-green-700">
                            <i class="bi bi-check-circle mr-1"></i>Approve
                        </button>
                        <button onclick="bulkAction('reject')" class="px-3 py-1 bg-red-600 text-white text-sm rounded-md hover:bg-red-700">
                            <i class="bi bi-x-circle mr-1"></i>Reject
                        </button>
                        <button onclick="bulkAction('delete')" class="px-3 py-1 bg-gray-600 text-white text-sm rounded-md hover:bg-gray-700">
                            <i class="bi bi-trash mr-1"></i>Delete
                        </button>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            {% if applications.has_other_pages %}
            <div class="px-6 py-3 border-t border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        Showing {{ applications.start_index }} to {{ applications.end_index }} of {{ applications.paginator.count }} results
                    </div>
                    <div class="flex space-x-1">
                        {% if applications.has_previous %}
                        <a href="?page={{ applications.previous_page_number }}" class="px-3 py-2 text-sm border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Previous</a>
                        {% endif %}
                        
                        {% for num in applications.paginator.page_range %}
                        {% if applications.number == num %}
                        <span class="px-3 py-2 text-sm bg-blue-600 text-white rounded-md">{{ num }}</span>
                        {% else %}
                        <a href="?page={{ num }}" class="px-3 py-2 text-sm border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">{{ num }}</a>
                        {% endif %}
                        {% endfor %}
                        
                        {% if applications.has_next %}
                        <a href="?page={{ applications.next_page_number }}" class="px-3 py-2 text-sm border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Next</a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden" id="deleteModal">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <i class="bi bi-exclamation-triangle text-red-600 text-xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mt-4">Confirm Deletion</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">Are you sure you want to delete this application? This action cannot be undone.</p>
            </div>
            <div class="items-center px-4 py-3">
                <button class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-24 mr-2 hover:bg-red-600" id="confirmDeleteBtn">Delete</button>
                <button class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-24" onclick="closeDeleteModal()">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedApplications = new Set();

    // Filter applications
    function filterApplications() {
        const councilFilter = document.querySelector('select:nth-of-type(1)').value;
        const statusFilter = document.querySelector('select:nth-of-type(2)').value;
        const typeFilter = document.querySelector('select:nth-of-type(3)').value;
        
        const rows = document.querySelectorAll('.application-row');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const council = row.dataset.council;
            const status = row.dataset.status;
            const type = row.dataset.type;
            
            const showCouncil = !councilFilter || council === councilFilter;
            const showStatus = !statusFilter || status === statusFilter;
            const showType = !typeFilter || type === typeFilter;
            
            if (showCouncil && showStatus && showType) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        document.getElementById('showing-count').textContent = visibleCount;
    }

    // Search applications
    function searchApplications() {
        const searchTerm = event.target.value.toLowerCase();
        const rows = document.querySelectorAll('.application-row');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        document.getElementById('showing-count').textContent = visibleCount;
    }

    // Clear filters
    function clearFilters() {
        document.querySelectorAll('select').forEach(select => select.value = '');
        document.querySelector('input[type="text"]').value = '';
        
        const rows = document.querySelectorAll('.application-row');
        rows.forEach(row => row.style.display = '');
        
        document.getElementById('showing-count').textContent = rows.length;
    }

    // Toggle select all
    function toggleSelectAll() {
        const selectAll = event.target.checked;
        const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll;
            if (selectAll) {
                selectedApplications.add(checkbox.value);
            } else {
                selectedApplications.delete(checkbox.value);
            }
        });
        
        updateBulkActions();
    }

    // Update bulk actions visibility
    function updateBulkActions() {
        const bulkActions = document.getElementById('bulk-actions');
        const selectedCount = document.getElementById('selected-count');
        
        if (selectedApplications.size > 0) {
            bulkActions.style.display = 'block';
            selectedCount.textContent = selectedApplications.size;
        } else {
            bulkActions.style.display = 'none';
        }
    }

    // Handle individual checkbox changes
    document.addEventListener('change', function(e) {
        if (e.target.type === 'checkbox' && e.target.value) {
            if (e.target.checked) {
                selectedApplications.add(e.target.value);
            } else {
                selectedApplications.delete(e.target.value);
            }
            updateBulkActions();
        }
    });

    // Bulk actions
    function bulkAction(action) {
        if (selectedApplications.size === 0) return;
        
        const message = `Are you sure you want to ${action} ${selectedApplications.size} applications?`;
        if (confirm(message)) {
            showAlert(`${action}ing ${selectedApplications.size} applications...`, 'info');
            
            // Here you would make the actual API call
            setTimeout(() => {
                showAlert(`Successfully ${action}ed applications!`, 'success');
                selectedApplications.clear();
                updateBulkActions();
            }, 2000);
        }
    }

    // Delete application
    function deleteApplication(id, type) {
        document.getElementById('deleteModal').classList.remove('hidden');
        
        document.getElementById('confirmDeleteBtn').onclick = function() {
            showAlert('Deleting application...', 'info');
            closeDeleteModal();
            
            // Here you would make the actual delete request
            setTimeout(() => {
                showAlert('Application deleted successfully!', 'success');
            }, 1000);
        };
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.add('hidden');
    }

    // Set view (list/card)
    function setView(viewType) {
        const buttons = document.querySelectorAll('button[onclick^="setView"]');
        buttons.forEach(btn => {
            btn.classList.remove('bg-blue-500', 'text-white');
            btn.classList.add('bg-gray-200', 'text-gray-700');
        });
        
        event.target.classList.remove('bg-gray-200', 'text-gray-700');
        event.target.classList.add('bg-blue-500', 'text-white');
        
        // Here you would implement the card view
        if (viewType === 'card') {
            showAlert('Card view coming soon!', 'info');
        }
    }
</script>
{% endblock %}
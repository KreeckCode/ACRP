{% extends 'base/base.html' %}

{% block title %}Sign Document - {{ signature_request.title }}{% endblock %}

{% block extra_head %}
<!-- Include Signature Pad library -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="card shadow-sm">
    <div class="card-header bg-secondary text-white">
      <h3><i class="bi bi-pencil"></i> Sign Document</h3>
    </div>
    <div class="card-body">
      <h5 class="card-title">{{ signature_request.title }}</h5>
      <p class="card-text">{{ signature_request.description }}</p>
      
      <!-- Display attached documents as PDFs -->
      {% if documents %}
        <div class="mb-4">
          <h6><i class="bi bi-file-earmark-pdf"></i> Attached Document{% if documents|length > 1 %}s{% endif %}</h6>
          {% for doc in documents %}
            <div class="mb-3">
              <iframe src="{{ doc.file.url }}" width="100%" height="400px" class="border rounded"></iframe>
            </div>
          {% endfor %}
        </div>
      {% endif %}
      
      <form method="post">
        {% csrf_token %}
        <div class="mb-3">
          <label for="signature-pad" class="form-label"><i class="bi bi-pen"></i> Provide Your Signature</label>
          <div class="border" style="height: 200px;">
            <canvas id="signature-pad" class="w-100" style="height: 200px;"></canvas>
          </div>
          <button type="button" id="clear-signature" class="btn btn-sm btn-outline-danger mt-2">
            <i class="bi bi-x-circle"></i> Clear Signature
          </button>
          {{ form.signature }}
        </div>
        <button type="submit" class="btn btn-success">
          <i class="bi bi-check-circle"></i> Submit Signature
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  // Initialize the signature pad
  var canvas = document.getElementById('signature-pad');
  var signaturePad = new SignaturePad(canvas);
  var clearButton = document.getElementById('clear-signature');
  var signatureInput = document.getElementById('id_signature');

  clearButton.addEventListener('click', function () {
    signaturePad.clear();
  });

  // Before form submission, save the signature as a Base64 string
  document.querySelector('form').addEventListener('submit', function (e) {
    if (signaturePad.isEmpty()) {
      alert("Please provide a signature.");
      e.preventDefault();
    } else {
      signatureInput.value = signaturePad.toDataURL();
    }
  });
</script>
{% endblock %}

{% extends 'base/base.html' %}
{% load static crispy_forms_tags %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>

<div class="container py-4">
  <div class="column-header d-flex align-items-center justify-content-between px-3 py-2">
        <h5 class="mb-0">{{ project.name }} Kanban</h5>
        <a href="{% url 'edit_project' project.pk %}" class="btn btn-sm btn-light">
          <i class="fas fa-cog"></i> Settings
        </a>
  </div>
    

  <div class="kanban-board">
    {% for status_key, label, tasks in tasks_by_status %}
    <div class="kanban-column" data-status="{{ status_key }}">
      <div class="column-header d-flex align-items-center justify-content-between px-3 py-2">
        <h5 class="mb-0">{{ label }}</h5>
        <button class="btn btn-sm btn-link text-muted add-task" data-status="{{ status_key }}">
          <i class="fas fa-plus"></i>
        </button>
      </div>
      <div class="column-body">
        {% for task in tasks %}
        <div class="kanban-card" data-task-id="{{ task.id }}">
          <div class="card-content">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <h6 class="mb-1">{{ task.title }}</h6>
                <div class="task-meta">
                  <small class="text-muted">
                    <i class="fas fa-calendar-alt me-1"></i>
                    {{ task.due_date|date:"M d" }}
                  </small>
                  {% if task.assigned_to %}
                  <small class="text-muted ms-2">
                    <i class="fas fa-user me-1"></i>
                    {{ task.assigned_to.get_full_name }}
                  </small>
                  {% endif %}
                </div>
              </div>
              <div class="task-actions">
                <button class="btn btn-link text-dark edit-task" data-task-id="{{ task.id }}">
                  <i class="fas fa-pencil-alt"></i>
                </button>
                <button class="btn btn-link text-danger delete-task">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            {% if task.tags.exists %}
            <div class="task-tags mt-2">
              {% for tag in task.tags.all %}
              <span class="badge bg-light text-dark border">{{ tag.name }}</span>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>
        {% empty %}
        <div class="empty-state">
          <i class="fas fa-tasks"></i>
          <p>No tasks here</p>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Task Modal -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="taskModalLabel">Create New Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="taskForm" method="post" enctype="multipart/form-data">
        <div class="modal-body">
          {% csrf_token %}
          {{ form|crispy }}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Save Task</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Task Detail Modal -->
<div class="modal fade" id="taskDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Task Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="taskDetailContent">
        <!-- Content loaded via AJAX -->
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const csrfToken = '{{ csrf_token }}';
  const projectPk = {{ project.pk }};
  const taskModal = new bootstrap.Modal('#taskModal');
  const detailModal = new bootstrap.Modal('#taskDetailModal');
  let currentTaskId = null;

  // Initialize Sortable
  document.querySelectorAll('.column-body').forEach(el => {
    new Sortable(el, {
      group: 'shared',
      animation: 150,
      onEnd: async e => {
        const taskId = e.item.dataset.taskId;
        const newStatus = e.to.closest('.kanban-column').dataset.status;
        
        try {
          const response = await fetch(`/tasks/${taskId}/move/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
          });

          if (!response.ok) throw new Error('Move failed');
          const data = await response.json();
          if(data.status !== 'ok') throw new Error(data.error);
        } catch (error) {
          console.error('Move error:', error);
          alert(error.message);
          e.from.insertBefore(e.item, e.from.children[e.oldIndex]);
        }
      }
    });
  });

  // Add Task
  document.querySelectorAll('.add-task').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelector('#id_project_task').value = projectPk;
      document.querySelector('#id_status').value = btn.dataset.status;
      taskModal.show();
    });
  });

  // Edit Task
  document.querySelectorAll('.edit-task').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      currentTaskId = e.currentTarget.dataset.taskId;
      const form = document.querySelector('#taskForm');
      form.action = `/tasks/${currentTaskId}/edit/`;
      
      try {
        const response = await fetch(`/tasks/${currentTaskId}/detail/`);
        if (!response.ok) throw new Error('Failed to load task');
        const task = await response.json();
        
        // Populate form
        document.querySelector('#id_title').value = task.title;
        document.querySelector('#id_description').value = task.description;
        document.querySelector('#id_due_date').value = task.due_date;
        document.querySelector('#id_status').value = task.status;
        document.querySelector('#id_assigned_to').value = task.assigned_to?.id;
        document.querySelector('#id_priority').value = task.priority;
        document.querySelector('#id_tag_input').value = task.tags.join(', ');
        
        taskModal.show();
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to load task details');
      }
    });
  });

  // Delete Task
  document.querySelectorAll('.delete-task').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const card = e.target.closest('.kanban-card');
      if (!confirm('Are you sure?')) return;

      try {
        const response = await fetch(`/tasks/${card.dataset.taskId}/delete/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrfToken }
        });
        
        if (response.ok) {
          card.remove();
        } else {
          throw new Error('Delete failed');
        }
      } catch (error) {
        console.error('Delete error:', error);
        alert('Failed to delete task');
      }
    });
  });

  // Task Form Submission
  document.querySelector('#taskForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    try {
      const response = await fetch(e.target.action || "{% url 'task_add' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken },
        body: formData
      });

      if (response.ok) {
        window.location.reload();
      } else {
        const error = await response.json();
        throw new Error(error.error);
      }
    } catch (error) {
      console.error('Error:', error);
      alert(error.message);
    }
  });

  // Task Detail Click
  document.querySelectorAll('.kanban-card').forEach(card => {
    card.addEventListener('click', async (e) => {
      if (!e.target.closest('.task-actions')) {
        const taskId = card.dataset.taskId;
        try {
          const response = await fetch(`/tasks/${taskId}/detail/`);
          if (!response.ok) throw new Error('Failed to load task');
          const task = await response.json();
          
          document.querySelector('#taskDetailContent').innerHTML = `
            <h5>${task.title}</h5>
            <div class="mb-3">${task.description}</div>
            <dl class="row">
              <dt class="col-sm-3">Due Date</dt>
              <dd class="col-sm-9">${task.due_date}</dd>
              <dt class="col-sm-3">Assigned To</dt>
              <dd class="col-sm-9">${task.assigned_to || 'Unassigned'}</dd>
              <dt class="col-sm-3">Status</dt>
              <dd class="col-sm-9">${task.status}</dd>
              ${task.attachment_url ? `
              <dt class="col-sm-3">Attachment</dt>
              <dd class="col-sm-9"><a href="${task.attachment_url}" target="_blank">Download</a></dd>
              ` : ''}
            </dl>
          `;
          detailModal.show();
        } catch (error) {
          console.error('Error:', error);
          alert('Failed to load task details');
        }
      }
    });
  });
});
</script>

<style>
  
/* Enhanced Monday.com-like styling */
.kanban-card {
  background: #ffffff;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  transition: all 0.2s ease;
}

.kanban-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.column-header {
  background: #f5f6f8;
  padding: 12px 16px;
  border-radius: 8px 8px 0 0;
}

.task-actions {
  opacity: 0;
  transition: opacity 0.2s ease;
}

.kanban-card:hover .task-actions {
  opacity: 1;
}

.empty-state {
  text-align: center;
  padding: 20px;
  color: #8993a4;
}

.empty-state i {
  font-size: 24px;
  margin-bottom: 8px;
}

.modal-content {
  border-radius: 12px;
  border: none;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
}

.task-meta {
  display: flex;
  align-items: center;
  margin-top: 8px;
}

.badge {
  font-size: 0.75rem;
  padding: 4px 8px;
  margin-right: 4px;
}
</style>

{% endblock %}
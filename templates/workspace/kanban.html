{% extends 'base/base.html' %}
{% load static crispy_forms_tags %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link rel="stylesheet" href="{% static 'workspace/kanban.css' %}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>

<div class="container py-4">
  <div class="d-flex align-items-center mb-3">
    <h3 class="me-auto">{{ project.name }} Kanban</h3>
    <a href="{% url 'edit_project' project.pk %}" class="btn btn-sm btn-light">
      <i class="fas fa-cog"></i> Settings
    </a>
  </div>

  <div class="kanban-board">
    {% for status_key, label, tasks in tasks_by_status %}
    <div class="kanban-column">
      <div class="column-header d-flex align-items-center justify-content-between px-3 py-2">
        <h5 class="mb-0">{{ label }}</h5>
        <button class="btn btn-sm btn-link text-muted add-task" data-status="{{ status_key }}">
          <i class="fas fa-plus"></i>
        </button>
      </div>
      <div class="column-body">
        {% for task in tasks %}
        <div class="kanban-card" data-task-id="{{ task.id }}">
          <div class="card-content">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <h6 class="mb-1">{{ task.title }}</h6>
                <div class="task-meta">
                  <small class="text-muted">
                    <i class="fas fa-calendar-alt me-1"></i>
                    {{ task.due_date|date:"M d" }}
                  </small>
                  {% if task.assigned_to %}
                  <small class="text-muted ms-2">
                    <i class="fas fa-user me-1"></i>
                    {{ task.assigned_to.first_name }}
                  </small>
                  {% endif %}
                </div>
              </div>
              <div class="task-actions">
                <button class="btn btn-link text-dark edit-task">
                  <i class="fas fa-pencil-alt"></i>
                </button>
                <button class="btn btn-link text-danger delete-task">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            {% if task.tags.exists %}
            <div class="task-tags mt-2">
              {% for tag in task.tags.all %}
              <span class="badge bg-light text-dark border">{{ tag.name }}</span>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>
        {% empty %}
        <div class="empty-state">
          <i class="fas fa-tasks"></i>
          <p>No tasks here</p>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Bootstrap Modal -->
<div class="modal fade" id="taskModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create New Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="taskForm" method="post">
        <div class="modal-body">
          {% csrf_token %}
          {{ form|crispy }}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Create Task</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const csrfToken = '{{ csrf_token }}';
  const projectPk = {{ project.pk }};
  let currentStatus = '';

  // Initialize Bootstrap modal
  const taskModal = new bootstrap.Modal(document.getElementById('taskModal'));

  // Add task button handler
  document.querySelectorAll('.add-task').forEach(btn => {
    btn.addEventListener('click', (e) => {
      currentStatus = e.currentTarget.dataset.status;
      document.querySelector('#id_status').value = currentStatus;
      document.querySelector('#id_project_task').value = projectPk;
      taskModal.show();
    });
  });

  // Form submission handler
  document.getElementById('taskForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    try {
      const response = await fetch("{% url 'task_add' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken
        },
        body: formData
      });

      if (response.ok) {
        window.location.reload();
      } else {
        const error = await response.json();
        throw new Error(error.error || 'Failed to create task');
      }
    } catch (error) {
      console.error('Error:', error);
      alert(error.message);
    }
  });

  // Drag & drop functionality
  document.querySelectorAll('.column-body').forEach(el => {
    new Sortable(el, {
      group: 'shared',
      animation: 150,
      onEnd: async e => {
        const taskId = e.item.dataset.taskId;
        const newStatus = e.to.closest('.kanban-column').dataset.status;

        try {
          const response = await fetch(`/tasks/${taskId}/move/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
          });

          if (!response.ok) throw new Error('Move failed');
        } catch (error) {
          console.error('Move error:', error);
          alert(error.message);
          e.from.insertBefore(e.item, e.from.children[e.oldIndex]);
        }
      }
    });
  });

  // Delete task handler
  document.querySelectorAll('.delete-task').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const card = e.target.closest('.kanban-card');
      if (!confirm('Are you sure you want to delete this task?')) return;

      try {
        const response = await fetch(`/tasks/${card.dataset.taskId}/delete/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrfToken }
        });

        if (response.ok) {
          card.remove();
        } else {
          throw new Error('Delete failed');
        }
      } catch (error) {
        console.error('Delete error:', error);
        alert('Failed to delete task');
      }
    });
  });
});
</script>

<style>
/* Enhanced Monday.com-like styling */
.kanban-card {
  background: #ffffff;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  transition: all 0.2s ease;
}

.kanban-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.column-header {
  background: #f5f6f8;
  padding: 12px 16px;
  border-radius: 8px 8px 0 0;
}

.task-actions {
  opacity: 0;
  transition: opacity 0.2s ease;
}

.kanban-card:hover .task-actions {
  opacity: 1;
}

.empty-state {
  text-align: center;
  padding: 20px;
  color: #8993a4;
}

.empty-state i {
  font-size: 24px;
  margin-bottom: 8px;
}

.modal-content {
  border-radius: 12px;
  border: none;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
}

.task-meta {
  display: flex;
  align-items: center;
  margin-top: 8px;
}

.badge {
  font-size: 0.75rem;
  padding: 4px 8px;
  margin-right: 4px;
}
</style>
{% endblock %}
{% extends "base/base.html" %}
{% load static %}

{% comment %}
ACRP Admin Send Card Template
=============================

This template provides the administrative interface for configuring and sending
digital affiliation cards to members via various delivery methods.

Template Features:
- Multiple delivery method selection (email PDF, email link, direct download)
- Customizable email content and formatting
- File format selection (PDF, PNG, JPG)
- Recipient configuration with validation
- Real-time preview of email content
- Delivery tracking and confirmation
- Responsive admin interface design

View Integration:
- Works with send_card view function  
- Uses CardDeliveryForm for all input validation
- Integrates with card delivery system
- Handles file generation and email sending

Data Context (from send_card view):
- card: AffiliationCard object being sent
- form: CardDeliveryForm instance with delivery configuration fields

Form Fields (CardDeliveryForm):
- delivery_method: Email PDF, Email Link, Direct Download
- recipient_email: Target email address
- recipient_name: Display name for recipient
- email_subject: Custom email subject line
- email_message: Custom email body content
- file_format: PDF, PNG, or JPG format selection

Design Philosophy:
- Professional admin interface
- Clear workflow progression
- Error prevention through validation
- Preview capabilities for confidence
- Comprehensive delivery options
- Detailed logging and tracking
{% endcomment %}

{% block title %}Send Card {{ card.card_number }} - ACRP{% endblock %}

{% block meta_description %}Configure and send ACRP digital affiliation card via email with customizable delivery options and formats.{% endblock %}

{% block page_title %}Send Card{% endblock %}

{% block page_description %}Configure delivery settings and send card to affiliate{% endblock %}

{% block page_header %}
<div class="mb-8">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                <i class="bi bi-send text-blue-600 mr-3"></i>
                Send Card {{ card.card_number }}
            </h1>
            <p class="mt-2 text-sm text-gray-600">
                Configure delivery method and send card to {{ card.get_display_name }}
            </p>
        </div>
        <div class="mt-4 lg:mt-0 flex space-x-3">
            <a href="{% url 'affiliationcard:card_detail' pk=card.pk %}" 
               class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors duration-200">
                <i class="bi bi-arrow-left mr-2"></i>
                Back to Card
            </a>
            <a href="{% url 'affiliationcard:card_list' %}" 
               class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors duration-200">
                <i class="bi bi-list-ul mr-2"></i>
                All Cards
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {% comment %}
        MAIN DELIVERY CONFIGURATION FORM
        =================================
        
        Left column contains the main configuration form with all delivery options.
        Uses progressive disclosure to show relevant fields based on delivery method.
        {% endcomment %}
        
        <!-- Main Configuration Form -->
        <div class="lg:col-span-2">
            
            <form method="post" id="send-card-form" class="space-y-6">
                {% csrf_token %}
                
                <!-- Delivery Method Selection -->
                <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900 flex items-center">
                            <span class="flex items-center justify-center w-8 h-8 bg-blue-100 text-blue-600 rounded-full text-sm font-bold mr-3">1</span>
                            Delivery Method
                        </h3>
                        <p class="mt-1 text-sm text-gray-600">Choose how to deliver the card to the affiliate</p>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            
                            <!-- Email PDF Attachment -->
                            <label class="relative cursor-pointer">
                                <input type="radio" name="delivery_method" value="email_pdf" class="sr-only peer" checked>
                                <div class="p-4 border-2 border-gray-200 rounded-lg peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-gray-300 transition-colors duration-200">
                                    <div class="text-center">
                                        <i class="bi bi-file-pdf text-2xl text-red-600 mb-2"></i>
                                        <h4 class="text-sm font-semibold text-gray-900">Email PDF</h4>
                                        <p class="text-xs text-gray-600 mt-1">Send card as PDF attachment</p>
                                    </div>
                                </div>
                            </label>
                            
                            <!-- Email Download Link -->
                            <label class="relative cursor-pointer">
                                <input type="radio" name="delivery_method" value="email_link" class="sr-only peer">
                                <div class="p-4 border-2 border-gray-200 rounded-lg peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-gray-300 transition-colors duration-200">
                                    <div class="text-center">
                                        <i class="bi bi-link-45deg text-2xl text-blue-600 mb-2"></i>
                                        <h4 class="text-sm font-semibold text-gray-900">Email Link</h4>
                                        <p class="text-xs text-gray-600 mt-1">Send secure download link</p>
                                    </div>
                                </div>
                            </label>
                            
                            <!-- Direct Download -->
                            <label class="relative cursor-pointer">
                                <input type="radio" name="delivery_method" value="direct_download" class="sr-only peer">
                                <div class="p-4 border-2 border-gray-200 rounded-lg peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-gray-300 transition-colors duration-200">
                                    <div class="text-center">
                                        <i class="bi bi-download text-2xl text-green-600 mb-2"></i>
                                        <h4 class="text-sm font-semibold text-gray-900">Direct Download</h4>
                                        <p class="text-xs text-gray-600 mt-1">Generate download link only</p>
                                    </div>
                                </div>
                            </label>
                            
                        </div>
                    </div>
                </div>
                
                <!-- Recipient Configuration -->
                <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900 flex items-center">
                            <span class="flex items-center justify-center w-8 h-8 bg-blue-100 text-blue-600 rounded-full text-sm font-bold mr-3">2</span>
                            Recipient Information
                        </h3>
                        <p class="mt-1 text-sm text-gray-600">Configure who will receive the card</p>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            
                            <!-- Recipient Email -->
                            <div>
                                <label for="id_recipient_email" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="bi bi-envelope mr-1"></i>
                                    Recipient Email Address <span class="text-red-500">*</span>
                                </label>
                                <input type="email" 
                                       id="id_recipient_email" 
                                       name="recipient_email" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       value="{{ card.affiliate_email }}"
                                       required>
                                <p class="mt-1 text-xs text-gray-500">Card will be sent to this email address</p>
                            </div>
                            
                            <!-- Recipient Name -->
                            <div>
                                <label for="id_recipient_name" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="bi bi-person mr-1"></i>
                                    Recipient Name <span class="text-red-500">*</span>
                                </label>
                                <input type="text" 
                                       id="id_recipient_name" 
                                       name="recipient_name" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       value="{{ card.get_display_name }}"
                                       required>
                                <p class="mt-1 text-xs text-gray-500">Name to use in email greeting</p>
                            </div>
                            
                        </div>
                    </div>
                </div>
                
                <!-- Email Configuration (shown for email delivery methods) -->
                <div class="bg-white shadow-sm rounded-lg border border-gray-200" id="email-config-section">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900 flex items-center">
                            <span class="flex items-center justify-center w-8 h-8 bg-blue-100 text-blue-600 rounded-full text-sm font-bold mr-3">3</span>
                            Email Configuration
                        </h3>
                        <p class="mt-1 text-sm text-gray-600">Customize the email content and appearance</p>
                    </div>
                    <div class="p-6">
                        <div class="space-y-6">
                            
                            <!-- Email Subject -->
                            <div>
                                <label for="id_email_subject" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="bi bi-text-left mr-1"></i>
                                    Email Subject
                                </label>
                                <input type="text" 
                                       id="id_email_subject" 
                                       name="email_subject" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       value="Your ACRP Digital Affiliation Card - {{ card.card_number }}"
                                       maxlength="200">
                                <p class="mt-1 text-xs text-gray-500">Keep subject lines clear and professional</p>
                            </div>
                            
                            <!-- Email Message -->
                            <div>
                                <label for="id_email_message" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="bi bi-chat-text mr-1"></i>
                                    Email Message
                                </label>
                                <textarea id="id_email_message" 
                                          name="email_message" 
                                          rows="6"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                          placeholder="Enter custom message or leave blank for default template">Dear {{ card.get_display_name }},

Your ACRP digital affiliation card is ready for download. This card serves as official verification of your affiliation with the Association of Christian Religious Practitioners.

Please keep this card secure and present it when requested for verification of your professional standing.

Thank you for your continued commitment to excellence in ministry.

Best regards,
ACRP Administration Team</textarea>
                                <p class="mt-1 text-xs text-gray-500">
                                    Personalize the message or leave blank to use the default template
                                </p>
                            </div>
                            
                            <!-- Email Template Preview -->
                            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                                    <i class="bi bi-eye mr-1"></i>
                                    Email Preview
                                </h4>
                                <div class="bg-white border border-gray-200 rounded p-3 text-xs" id="email-preview">
                                    <div class="border-b border-gray-200 pb-2 mb-2">
                                        <strong>To:</strong> <span id="preview-recipient">{{ card.affiliate_email }}</span><br>
                                        <strong>Subject:</strong> <span id="preview-subject">Your ACRP Digital Affiliation Card - {{ card.card_number }}</span>
                                    </div>
                                    <div id="preview-message" class="whitespace-pre-line text-gray-700">
                                        Loading preview...
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
                
                <!-- File Format Selection -->
                <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900 flex items-center">
                            <span class="flex items-center justify-center w-8 h-8 bg-blue-100 text-blue-600 rounded-full text-sm font-bold mr-3">4</span>
                            File Format
                        </h3>
                        <p class="mt-1 text-sm text-gray-600">Choose the format for the card file</p>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            
                            <!-- PDF Format -->
                            <label class="relative cursor-pointer">
                                <input type="radio" name="file_format" value="pdf" class="sr-only peer" checked>
                                <div class="p-4 border-2 border-gray-200 rounded-lg peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-gray-300 transition-colors duration-200">
                                    <div class="text-center">
                                        <i class="bi bi-file-pdf text-2xl text-red-600 mb-2"></i>
                                        <h4 class="text-sm font-semibold text-gray-900">PDF Document</h4>
                                        <p class="text-xs text-gray-600 mt-1">Professional, printable format</p>
                                        <div class="mt-2 text-xs text-gray-500">
                                            <i class="bi bi-check-circle mr-1"></i>Recommended
                                        </div>
                                    </div>
                                </div>
                            </label>
                            
                            <!-- PNG Format -->
                            <label class="relative cursor-pointer">
                                <input type="radio" name="file_format" value="png" class="sr-only peer">
                                <div class="p-4 border-2 border-gray-200 rounded-lg peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-gray-300 transition-colors duration-200">
                                    <div class="text-center">
                                        <i class="bi bi-image text-2xl text-blue-600 mb-2"></i>
                                        <h4 class="text-sm font-semibold text-gray-900">PNG Image</h4>
                                        <p class="text-xs text-gray-600 mt-1">High quality image format</p>
                                        <div class="mt-2 text-xs text-gray-500">
                                            <i class="bi bi-info-circle mr-1"></i>Transparent background
                                        </div>
                                    </div>
                                </div>
                            </label>
                            
                            <!-- JPG Format -->
                            <label class="relative cursor-pointer">
                                <input type="radio" name="file_format" value="jpg" class="sr-only peer">
                                <div class="p-4 border-2 border-gray-200 rounded-lg peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-gray-300 transition-colors duration-200">
                                    <div class="text-center">
                                        <i class="bi bi-image-fill text-2xl text-green-600 mb-2"></i>
                                        <h4 class="text-sm font-semibold text-gray-900">JPG Image</h4>
                                        <p class="text-xs text-gray-600 mt-1">Compressed image format</p>
                                        <div class="mt-2 text-xs text-gray-500">
                                            <i class="bi bi-info-circle mr-1"></i>Smaller file size
                                        </div>
                                    </div>
                                </div>
                            </label>
                            
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Options -->
                <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900 flex items-center">
                            <span class="flex items-center justify-center w-8 h-8 bg-blue-100 text-blue-600 rounded-full text-sm font-bold mr-3">5</span>
                            Advanced Options
                        </h3>
                        <p class="mt-1 text-sm text-gray-600">Additional delivery settings and preferences</p>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            







                                <div>
                                    <label for="id_priority" class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="bi bi-speedometer2 mr-1"></i>
                                        Delivery Priority
                                    </label>
                                    <select id="id_priority" name="priority" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="normal" selected>Normal Priority</option>
                                        <option value="high">High Priority</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                    <p class="mt-1 text-xs text-gray-500">Set delivery priority level</p>
                                </div>





                            
                            <!-- Delivery Options -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                
                                <div>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="send_notification" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                        <span class="ml-2 text-sm text-gray-700">Send delivery notification</span>
                                    </label>
                                    <p class="ml-6 text-xs text-gray-500">Notify when card is successfully delivered</p>
                                </div>
                                
                                <div>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="require_download_confirmation" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <span class="ml-2 text-sm text-gray-700">Require download confirmation</span>
                                    </label>
                                    <p class="ml-6 text-xs text-gray-500">Request confirmation when card is downloaded</p>
                                </div>
                                
                                <div>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="include_instructions" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                        <span class="ml-2 text-sm text-gray-700">Include usage instructions</span>
                                    </label>
                                    <p class="ml-6 text-xs text-gray-500">Add instructions on how to use the digital card</p>
                                </div>
                                
                                <div id="download-expiry-option" class="hidden">
                                    <label for="id_download_expiry_days" class="block text-sm font-medium text-gray-700 mb-1">
                                        Download Link Expiry (Days)
                                    </label>
                                    <input type="number" 
                                           id="id_download_expiry_days" 
                                           name="download_expiry_days" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                           value="7"
                                           min="1"
                                           max="30">
                                    <p class="mt-1 text-xs text-gray-500">Link expires after this many days</p>
                                </div>
                                
                            </div>
                            
                        </div>
                    </div>
                </div>
                
                <!-- Send Button -->
                <div class="flex justify-end space-x-4">
                    <button type="button" 
                            class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200"
                            onclick="previewDelivery()">
                        <i class="bi bi-eye mr-2"></i>
                        Preview
                    </button>
                    <button type="submit" 
                            id="send-btn"
                            class="inline-flex items-center px-6 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200">
                        <i class="bi bi-send mr-2"></i>
                        <span id="send-btn-text">Send Card</span>
                        <div class="hidden ml-2 loading-spinner">
                            <i class="bi bi-arrow-clockwise"></i>
                        </div>
                    </button>
                </div>
                
            </form>
            
        </div>
        
        {% comment %}
        CARD INFORMATION SIDEBAR
        ========================
        
        Right column shows detailed information about the card being sent.
        Provides context and confirmation of what's being delivered.
        {% endcomment %}
        
        <!-- Card Information Sidebar -->
        <div class="lg:col-span-1">
            
            <!-- Card Summary -->
            <div class="bg-white shadow-sm rounded-lg border border-gray-200 mb-6 sticky top-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900 flex items-center">
                        <i class="bi bi-credit-card text-blue-600 mr-2"></i>
                        Card Summary
                    </h3>
                </div>
                <div class="p-6">
                    
                    <!-- Card Visual Preview -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-100 border-2 border-blue-200 rounded-lg p-4 mb-4 text-center">
                        <div class="mb-3">
                            {% if card.affiliate_photo %}
                            <img class="h-16 w-16 rounded-full object-cover mx-auto border-2 border-white shadow" 
                                 src="{{ card.affiliate_photo.url }}" 
                                 alt="{{ card.get_display_name }}">
                            {% else %}
                            <div class="h-16 w-16 bg-gray-300 rounded-full flex items-center justify-center mx-auto border-2 border-white shadow">
                                <i class="bi bi-person text-gray-600 text-xl"></i>
                            </div>
                            {% endif %}
                        </div>
                        <div class="text-sm font-semibold text-blue-900">{{ card.get_display_name }}</div>
                        <div class="text-xs text-blue-700">{{ card.get_card_type_display }}</div>
                        <div class="text-xs text-blue-600 mt-2 font-mono">{{ card.card_number }}</div>
                    </div>
                    
                    <!-- Card Details -->
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-600">Status:</span>
                            <span class="font-semibold {% if card.status == 'active' %}text-green-600{% elif card.status == 'pending_assignment' %}text-yellow-600{% elif card.status == 'assigned' %}text-blue-600{% else %}text-gray-600{% endif %}">
                                {{ card.get_status_display }}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-600">Council:</span>
                            <span class="text-gray-900">{{ card.council_code }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-600">Type:</span>
                            <span class="text-gray-900">{{ card.affiliation_type|title }}</span>
                        </div>
                        {% if card.date_issued %}
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-600">Issued:</span>
                            <span class="text-gray-900">{{ card.date_issued|date:"M d, Y" }}</span>
                        </div>
                        {% endif %}
                        {% if card.date_expires %}
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-600">Expires:</span>
                            <span class="text-gray-900">{{ card.date_expires|date:"M d, Y" }}</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <div class="text-center">
                            <div class="text-lg font-bold text-gray-900">{{ card.total_verifications }}</div>
                            <div class="text-xs text-gray-600">Total Verifications</div>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- Previous Deliveries -->
            <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-md font-medium text-gray-900 flex items-center">
                        <i class="bi bi-clock-history text-gray-500 mr-2"></i>
                        Previous Deliveries
                    </h3>
                </div>
                <div class="p-6">
                    {% if card.deliveries.all %}
                    <div class="space-y-3">
                        {% for delivery in card.deliveries.all|slice:":5" %}
                        <div class="flex items-center justify-between text-sm">
                            <div>
                                <div class="font-medium text-gray-900">
                                    {% if delivery.delivery_type == 'email_pdf' %}
                                    <i class="bi bi-file-pdf text-red-600 mr-1"></i>Email PDF
                                    {% elif delivery.delivery_type == 'email_link' %}
                                    <i class="bi bi-link text-blue-600 mr-1"></i>Email Link
                                    {% else %}
                                    <i class="bi bi-download text-green-600 mr-1"></i>{{ delivery.get_delivery_type_display }}
                                    {% endif %}
                                </div>
                                <div class="text-xs text-gray-500">
                                    {{ delivery.initiated_at|date:"M d, Y H:i" }}
                                </div>
                            </div>
                            <div>
                                {% if delivery.status == 'completed' or delivery.status == 'downloaded' %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="bi bi-check-circle mr-1"></i>
                                    Success
                                </span>
                                {% elif delivery.status == 'failed' %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    <i class="bi bi-x-circle mr-1"></i>
                                    Failed
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                    <i class="bi bi-clock mr-1"></i>
                                    {{ delivery.get_status_display }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if card.deliveries.count > 5 %}
                        <div class="text-center pt-2 border-t border-gray-200">
                            <a href="{% url 'affiliationcard:card_detail' pk=card.pk %}" 
                               class="text-xs text-blue-600 hover:text-blue-700">
                                View all {{ card.deliveries.count }} deliveries
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-inbox text-gray-400 text-2xl mb-2"></i>
                        <p class="text-sm text-gray-500">No previous deliveries</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
        </div>
        
    </div>
    
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Custom radio button styling for delivery methods */
    input[type="radio"]:checked + div {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        transform: translateY(-1px);
    }
    
    /* Email preview styling */
    #email-preview {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.4;
        max-height: 200px;
        overflow-y: auto;
    }
    
    /* Loading animation for send button */
    .loading-spinner i {
        animation: spin 1s linear infinite;
    }
    
    /* Form section animations */
    .form-section {
        animation: slideInLeft 0.5s ease-out;
    }
    
    @keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    /* Sticky sidebar enhancements */
    .sticky {
        top: 2rem;
    }
    
    @media (max-width: 1024px) {
        .sticky {
            position: static;
        }
    }
    
    /* Enhanced card preview */
    .card-preview {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        transform: perspective(1000px) rotateY(-5deg);
        transition: transform 0.3s ease;
    }
    
    .card-preview:hover {
        transform: perspective(1000px) rotateY(0deg);
    }
    
    /* Delivery method selection animations */
    .delivery-method:hover {
        transform: scale(1.02);
        transition: transform 0.2s ease;
    }
    
    /* Form validation styling */
    .form-field.error {
        border-color: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }
    
    .form-field.success {
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    /**
     * Send Card JavaScript
     * ====================
     * 
     * This script handles the interactive elements of the card sending form,
     * including real-time preview updates, form validation, and submission handling.
     */
    
    document.addEventListener('DOMContentLoaded', function() {
        
        // Initialize send card form
        initializeSendCardForm();
        
        // Set up real-time preview
        setupEmailPreview();
        
        // Configure delivery method handlers
        setupDeliveryMethodHandlers();
        
        // Set up form validation
        setupFormValidation();
        
    });
    
    /**
     * Initialize send card form with event listeners
     */
    function initializeSendCardForm() {
        
        // Handle form submission
        document.getElementById('send-card-form').addEventListener('submit', function(event) {
            event.preventDefault();
            handleFormSubmission();
        });
        
        // Update email preview when content changes
        document.getElementById('id_email_subject').addEventListener('input', updateEmailPreview);
        document.getElementById('id_email_message').addEventListener('input', updateEmailPreview);
        document.getElementById('id_recipient_email').addEventListener('input', updateEmailPreview);
        
        // Initial preview update
        updateEmailPreview();
        
    }
    
    /**
     * Set up email preview functionality
     */
    function setupEmailPreview() {
        
        // Update preview immediately
        updateEmailPreview();
        
        // Update preview when recipient info changes
        document.getElementById('id_recipient_name').addEventListener('input', function() {
            updateEmailPreview();
        });
        
    }
    
    /**
     * Update email preview in real-time
     */
    function updateEmailPreview() {
        const recipientEmail = document.getElementById('id_recipient_email').value || '{{ card.affiliate_email }}';
        const subject = document.getElementById('id_email_subject').value || 'Your ACRP Digital Affiliation Card';
        const message = document.getElementById('id_email_message').value || 'Default email template will be used';
        
        document.getElementById('preview-recipient').textContent = recipientEmail;
        document.getElementById('preview-subject').textContent = subject;
        document.getElementById('preview-message').textContent = message;
    }
    
    /**
     * Set up delivery method change handlers
     */
    function setupDeliveryMethodHandlers() {
        
        document.querySelectorAll('input[name="delivery_method"]').forEach(radio => {
            radio.addEventListener('change', function() {
                handleDeliveryMethodChange(this.value);
            });
        });
        
        // Initial setup
        const checkedMethod = document.querySelector('input[name="delivery_method"]:checked');
        if (checkedMethod) {
            handleDeliveryMethodChange(checkedMethod.value);
        }
        
    }
    
    /**
     * Handle delivery method changes
     */
    function handleDeliveryMethodChange(method) {
        const emailConfigSection = document.getElementById('email-config-section');
        const downloadExpiryOption = document.getElementById('download-expiry-option');
        
        // Show/hide email configuration based on method
        if (method === 'direct_download') {
            emailConfigSection.style.display = 'none';
            downloadExpiryOption.classList.remove('hidden');
        } else {
            emailConfigSection.style.display = 'block';
            if (method === 'email_link') {
                downloadExpiryOption.classList.remove('hidden');
            } else {
                downloadExpiryOption.classList.add('hidden');
            }
        }
        
        // Update preview based on method
        updateDeliveryPreview(method);
    }
    
    /**
     * Update delivery preview based on selected method
     */
    function updateDeliveryPreview(method) {
        let previewText = '';
        
        switch(method) {
            case 'email_pdf':
                previewText = 'Card will be sent as a PDF attachment via email';
                break;
            case 'email_link':
                previewText = 'A secure download link will be sent via email';
                break;
            case 'direct_download':
                previewText = 'A direct download link will be generated';
                break;
        }
        
        // Update any preview elements
        console.log('Delivery method changed to:', method, previewText);
    }
    
    /**
     * Set up form validation
     */
    function setupFormValidation() {
        
        // Email validation
        document.getElementById('id_recipient_email').addEventListener('blur', function() {
            validateEmail(this);
        });
        
        // Required field validation
        document.querySelectorAll('input[required], textarea[required]').forEach(field => {
            field.addEventListener('blur', function() {
                validateRequiredField(this);
            });
        });
        
    }
    
    /**
     * Validate email field
     */
    function validateEmail(emailField) {
        const email = emailField.value.trim();
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        emailField.classList.remove('form-field', 'error', 'success');
        emailField.classList.add('form-field');
        
        if (email && !emailPattern.test(email)) {
            emailField.classList.add('error');
            showToast('Please enter a valid email address', 'error');
        } else if (email) {
            emailField.classList.add('success');
        }
    }
    
    /**
     * Validate required fields
     */
    function validateRequiredField(field) {
        field.classList.remove('form-field', 'error', 'success');
        field.classList.add('form-field');
        
        if (!field.value.trim()) {
            field.classList.add('error');
        } else {
            field.classList.add('success');
        }
    }
    
    /**
     * Handle form submission with loading states and validation
     */
    function handleFormSubmission() {
        
        // Validate form before submission
        if (!validateForm()) {
            return;
        }
        
        const sendBtn = document.getElementById('send-btn');
        const sendBtnText = document.getElementById('send-btn-text');
        const spinner = sendBtn.querySelector('.loading-spinner');
        
        // Show loading state
        sendBtnText.textContent = 'Sending...';
        spinner.classList.remove('hidden');
        sendBtn.disabled = true;
        sendBtn.classList.add('opacity-75', 'cursor-not-allowed');
        
        // Show progress message
        showToast('Preparing card delivery...', 'info');
        
        // Submit form
        document.getElementById('send-card-form').submit();
    }
    
    /**
     * Validate entire form before submission
     */
    function validateForm() {
        let isValid = true;
        
        // Check required fields
        const requiredFields = document.querySelectorAll('input[required], textarea[required]');
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('form-field', 'error');
                isValid = false;
            }
        });
        
        // Validate email format
        const emailField = document.getElementById('id_recipient_email');
        const email = emailField.value.trim();
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if (email && !emailPattern.test(email)) {
            emailField.classList.add('form-field', 'error');
            isValid = false;
        }
        
        if (!isValid) {
            showToast('Please correct the highlighted fields before sending', 'error');
        }
        
        return isValid;
    }
    
    /**
     * Preview delivery before sending
     */
    function previewDelivery() {
        const method = document.querySelector('input[name="delivery_method"]:checked').value;
        const format = document.querySelector('input[name="file_format"]:checked').value;
        const email = document.getElementById('id_recipient_email').value;
        const name = document.getElementById('id_recipient_name').value;
        
        // Show preview modal or toast
        const previewText = `
Delivery Summary:
- Method: ${method.replace('_', ' ').toUpperCase()}
- Format: ${format.toUpperCase()}
- Recipient: ${name} (${email})
- Card: {{ card.card_number }}
        `;
        
        if (confirm(`Please review the delivery details:\n\n${previewText}\n\nProceed with sending?`)) {
            handleFormSubmission();
        }
    }
    
    /**
     * Auto-save form data as user types (optional enhancement)
     */
    function autoSaveFormData() {
        const formData = {
            delivery_method: document.querySelector('input[name="delivery_method"]:checked')?.value,
            recipient_email: document.getElementById('id_recipient_email').value,
            recipient_name: document.getElementById('id_recipient_name').value,
            email_subject: document.getElementById('id_email_subject').value,
            email_message: document.getElementById('id_email_message').value,
            file_format: document.querySelector('input[name="file_format"]:checked')?.value
        };
        
        sessionStorage.setItem('sendCardForm', JSON.stringify(formData));
    }
    
    /**
     * Restore form data from auto-save
     */
    function restoreFormData() {
        const savedData = sessionStorage.getItem('sendCardForm');
        if (savedData) {
            const formData = JSON.parse(savedData);
            
            // Restore form values
            Object.keys(formData).forEach(key => {
                const element = document.getElementById(`id_${key}`) || 
                              document.querySelector(`input[name="${key}"][value="${formData[key]}"]`);
                if (element) {
                    if (element.type === 'radio') {
                        element.checked = true;
                    } else {
                        element.value = formData[key] || '';
                    }
                }
            });
            
            updateEmailPreview();
        }
    }
    
    /**
     * Clear auto-saved form data
     */
    function clearAutoSave() {
        sessionStorage.removeItem('sendCardForm');
    }
    function testEmailConfiguration() {
        showToast('Email configuration test functionality coming soon!', 'info');
    }
    
</script>
{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "Send ACRP Card - {{ card.card_number }}",
    "description": "Administrative interface for sending ACRP digital affiliation cards",
    "url": "{{ request.build_absolute_uri }}",
    "isPartOf": {
        "@type": "WebSite",
        "name": "ACRP Management System",
        "url": "{{ request.scheme }}://{{ request.get_host }}"
    }
}
</script>
{% endblock %}
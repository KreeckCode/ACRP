{% extends 'base/chat_base.html' %}
{% load crispy_forms_tags %}
{% block title %}Chat Room: {{ room.name }}{% endblock %}
{% block content %}
<div class="card mt-4">
  <div class="card-header bg-primary text-white">
    {{ room.name }}
    <a href="{% url 'chat:chat_room_list' %}" class="btn btn-sm btn-light float-right">Back to Rooms</a>
  </div>
  <div class="card-body">
    <p><strong>Participants:</strong>
      {% for participant in room.participants.all %}
        {{ participant.username }}{% if not forloop.last %}, {% endif %}
      {% endfor %}
    </p>
    <hr>
    <div id="chat-messages" class="chat-messages">
      {% for msg in messages %}
        <div class="card message-card {% if msg.sender == request.user %}border-primary{% endif %}">
          <div class="card-header {% if msg.sender == request.user %}bg-primary text-white{% else %}bg-light{% endif %}">
            {{ msg.sender.username }} 
            <small class="text-muted">{{ msg.created_at|date:"SHORT_DATETIME_FORMAT" }}</small>
          </div>
          <div class="card-body">
            <p>{{ msg.content }}</p>
            {% if msg.attachment %}
              <p><a href="{{ msg.attachment.url }}" target="_blank">View Attachment</a></p>
            {% endif %}
          </div>
        </div>
      {% empty %}
        <p class="text-muted">No messages yet. Start the conversation!</p>
      {% endfor %}
    </div>
    <hr>
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      {{ form|crispy }}
      <button type="submit" class="btn btn-primary mt-2">Send Message</button>
    </form>
  </div>
</div>
<script>
  // Auto-scroll chat container to the bottom
  var chatMessages = document.getElementById("chat-messages");
  if(chatMessages) {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
</script>
{% endblock %}

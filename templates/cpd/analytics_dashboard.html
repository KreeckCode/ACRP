{% extends 'base/base.html' %}
{% load static %}

{% block title %}CPD Analytics Dashboard | ACRP{% endblock %}

{% block page_title %}CPD Analytics Dashboard{% endblock %}

{% block page_description %}Comprehensive insights and performance metrics{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Period Selection -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-medium text-gray-900">Analytics Period</h3>
                <p class="text-sm text-gray-600">Select a CPD period to analyze performance metrics</p>
            </div>
            <div class="flex items-center space-x-3">
                <form method="get" class="flex items-center space-x-2">
                    <select name="period" onchange="this.form.submit()" 
                            class="border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        {% for p in all_periods %}
                            <option value="{{ p.pk }}" {% if p.pk == period.pk %}selected{% endif %}>
                                {{ p.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <noscript>
                        <button type="submit" class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                            Load Period
                        </button>
                    </noscript>
                </form>
                <span class="text-sm text-gray-500">
                    {{ period.start_date|date:"M d, Y" }} - {{ period.end_date|date:"M d, Y" }}
                </span>
            </div>
        </div>
    </div>

    <!-- Key Metrics Overview -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Participants</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ compliance_stats.total_users|default:0 }}</p>
                </div>
                <div class="p-3 bg-blue-50 rounded-full">
                    <i class="bi bi-people text-blue-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-2">
                <span class="text-xs text-gray-500">Active CPD participants</span>
            </div>
        </div>

        <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Compliance Rate</p>
                    <p class="text-2xl font-semibold text-green-600">
                        {% if compliance_stats.total_users %}
                            {{ compliance_stats.compliant|default:0 }}
                            <span class="text-sm text-gray-500">
                                ({{ compliance_stats.compliant|default:0|floatformat:0 }}/{{ compliance_stats.total_users }})
                            </span>
                        {% else %}
                            0%
                        {% endif %}
                    </p>
                </div>
                <div class="p-3 bg-green-50 rounded-full">
                    <i class="bi bi-check-circle text-green-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-2">
                <span class="text-xs text-gray-500">Fully compliant users</span>
            </div>
        </div>

        <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Average Points</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ compliance_stats.avg_points|default:0|floatformat:1 }}</p>
                </div>
                <div class="p-3 bg-yellow-50 rounded-full">
                    <i class="bi bi-award text-yellow-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-2">
                <span class="text-xs text-gray-500">Points per participant</span>
            </div>
        </div>

        <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Activities</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ activity_stats.total_activities|default:0 }}</p>
                </div>
                <div class="p-3 bg-purple-50 rounded-full">
                    <i class="bi bi-calendar-event text-purple-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-2">
                <span class="text-xs text-gray-500">Available CPD activities</span>
            </div>
        </div>
    </div>

    <!-- Compliance Breakdown -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Compliance Status Distribution -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Compliance Status Distribution</h3>
            
            {% if compliance_stats.total_users %}
                <div class="space-y-4">
                    <!-- Compliant -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-4 h-4 bg-green-500 rounded"></div>
                            <span class="text-sm font-medium text-gray-700">Compliant</span>
                        </div>
                        <div class="text-right">
                            <span class="text-sm font-semibold text-gray-900">{{ compliance_stats.compliant|default:0 }}</span>
                            <span class="text-xs text-gray-500 ml-1">
                                ({% widthratio compliance_stats.compliant|default:0 compliance_stats.total_users 100 %}%)
                            </span>
                        </div>
                    </div>
                    
                    <!-- At Risk -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-4 h-4 bg-amber-500 rounded"></div>
                            <span class="text-sm font-medium text-gray-700">At Risk</span>
                        </div>
                        <div class="text-right">
                            <span class="text-sm font-semibold text-gray-900">{{ compliance_stats.at_risk|default:0 }}</span>
                            <span class="text-xs text-gray-500 ml-1">
                                ({% widthratio compliance_stats.at_risk|default:0 compliance_stats.total_users 100 %}%)
                            </span>
                        </div>
                    </div>
                    
                    <!-- Non-Compliant -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-4 h-4 bg-red-500 rounded"></div>
                            <span class="text-sm font-medium text-gray-700">Non-Compliant</span>
                        </div>
                        <div class="text-right">
                            <span class="text-sm font-semibold text-gray-900">{{ compliance_stats.non_compliant|default:0 }}</span>
                            <span class="text-xs text-gray-500 ml-1">
                                ({% widthratio compliance_stats.non_compliant|default:0 compliance_stats.total_users 100 %}%)
                            </span>
                        </div>
                    </div>
                    
                    <!-- Visual Progress Bar -->
                    <div class="pt-4 border-t border-gray-200">
                        <div class="flex rounded-full h-4 bg-gray-200 overflow-hidden">
                            {% if compliance_stats.compliant %}
                                <div class="bg-green-500" style="width: {% widthratio compliance_stats.compliant compliance_stats.total_users 100 %}%"></div>
                            {% endif %}
                            {% if compliance_stats.at_risk %}
                                <div class="bg-amber-500" style="width: {% widthratio compliance_stats.at_risk compliance_stats.total_users 100 %}%"></div>
                            {% endif %}
                            {% if compliance_stats.non_compliant %}
                                <div class="bg-red-500" style="width: {% widthratio compliance_stats.non_compliant compliance_stats.total_users 100 %}%"></div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="text-center py-8">
                    <i class="bi bi-info-circle text-gray-400 text-2xl mb-2"></i>
                    <p class="text-sm text-gray-600">No compliance data available for this period</p>
                </div>
            {% endif %}
        </div>

        <!-- Activity Performance -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Activity Performance Summary</h3>
            
            <div class="space-y-4">
                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                    <span class="text-sm text-gray-600">Total Activities</span>
                    <span class="text-sm font-semibold text-gray-900">{{ activity_stats.total_activities|default:0 }}</span>
                </div>
                
                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                    <span class="text-sm text-gray-600">Avg. Participants per Activity</span>
                    <span class="text-sm font-semibold text-gray-900">{{ activity_stats.avg_participants|default:0|floatformat:1 }}</span>
                </div>
                
                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                    <span class="text-sm text-gray-600">Average Rating</span>
                    <div class="flex items-center space-x-1">
                        {% if activity_stats.avg_rating %}
                            {% for i in "12345" %}
                                <i class="bi bi-star{% if i|add:0 <= activity_stats.avg_rating %}-fill{% endif %} text-yellow-400 text-sm"></i>
                            {% endfor %}
                            <span class="text-sm font-semibold text-gray-900 ml-1">{{ activity_stats.avg_rating|floatformat:1 }}</span>
                        {% else %}
                            <span class="text-sm text-gray-500">No ratings yet</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="flex justify-between items-center py-2">
                    <span class="text-sm text-gray-600">Avg. Hours per Participant</span>
                    <span class="text-sm font-semibold text-gray-900">{{ compliance_stats.avg_hours|default:0|floatformat:1 }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Activity Timeline</h3>
        
        <!-- Chart Container -->
        <div class="h-64 flex items-center justify-center border border-gray-200 rounded-lg bg-gray-50">
            <div class="text-center">
                <i class="bi bi-bar-chart text-gray-400 text-3xl mb-2"></i>
                <p class="text-sm text-gray-600">Activity timeline chart</p>
                <p class="text-xs text-gray-500">Chart integration with {{ timeline_data|length }} data points</p>
            </div>
        </div>
        
        <!-- Chart Legend -->
        <div class="mt-4 flex items-center justify-center space-x-6">
            <div class="flex items-center space-x-2">
                <div class="w-3 h-3 bg-blue-500 rounded"></div>
                <span class="text-sm text-gray-600">Daily Records</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-3 h-3 bg-green-500 rounded"></div>
                <span class="text-sm text-gray-600">Points Earned</span>
            </div>
        </div>
    </div>

    <!-- Category Performance -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium text-gray-900">Category Performance</h3>
            <span class="text-sm text-gray-500">Ranked by participation</span>
        </div>
        
        {% if category_stats %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Records</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Points</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Rating</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Popularity</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for category in category_stats %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-2 w-2 bg-blue-500 rounded-full mr-3"></div>
                                        <div class="text-sm font-medium text-gray-900">{{ category.name }}</div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    {{ category.total_records|default:0 }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    {{ category.total_points|default:0|floatformat:0 }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if category.avg_rating %}
                                        <div class="flex items-center">
                                            {% for i in "12345" %}
                                                <i class="bi bi-star{% if i|add:0 <= category.avg_rating %}-fill{% endif %} text-yellow-400 text-xs"></i>
                                            {% endfor %}
                                            <span class="text-sm text-gray-600 ml-1">{{ category.avg_rating|floatformat:1 }}</span>
                                        </div>
                                    {% else %}
                                        <span class="text-sm text-gray-400">-</span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-1 bg-gray-200 rounded-full h-2 mr-2">
                                            {% if category_stats %}
                                                <div class="bg-blue-500 h-2 rounded-full" 
                                                     style="width: {% widthratio category.total_records category_stats.0.total_records 100 %}%"></div>
                                            {% endif %}
                                        </div>
                                        <span class="text-xs text-gray-500">
                                            {% if category_stats %}
                                                {% widthratio category.total_records category_stats.0.total_records 100 %}%
                                            {% else %}
                                                0%
                                            {% endif %}
                                        </span>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-8">
                <i class="bi bi-pie-chart text-gray-400 text-2xl mb-2"></i>
                <p class="text-sm text-gray-600">No category data available</p>
            </div>
        {% endif %}
    </div>

    <!-- Provider Performance & At-Risk Users -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Top Providers -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Top Providers</h3>
                <span class="text-sm text-gray-500">By participation</span>
            </div>
            
            {% if provider_stats %}
                <div class="space-y-4">
                    {% for provider in provider_stats %}
                        <div class="flex items-center justify-between">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 truncate">{{ provider.name }}</p>
                                <p class="text-xs text-gray-500">
                                    {{ provider.total_activities }} activities • 
                                    {% if provider.avg_rating %}
                                        {{ provider.avg_rating|floatformat:1 }}⭐
                                    {% else %}
                                        No rating
                                    {% endif %}
                                </p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-semibold text-gray-900">{{ provider.total_participants }}</p>
                                <p class="text-xs text-gray-500">participants</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-6">
                    <i class="bi bi-building text-gray-400 text-2xl mb-2"></i>
                    <p class="text-sm text-gray-600">No provider data available</p>
                </div>
            {% endif %}
        </div>

        <!-- At-Risk Users -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Users At Risk</h3>
                {% if at_risk_users %}
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                        {{ at_risk_users|length }} users
                    </span>
                {% endif %}
            </div>
            
            {% if at_risk_users %}
                <div class="space-y-3 max-h-80 overflow-y-auto">
                    {% for compliance in at_risk_users %}
                        <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                            <div>
                                <p class="text-sm font-medium text-gray-900">{{ compliance.user.get_full_name }}</p>
                                <p class="text-xs text-gray-500">{{ compliance.user.email }}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-semibold
                                    {% if compliance.compliance_status == 'NON_COMPLIANT' %}text-red-600
                                    {% else %}text-amber-600{% endif %}">
                                    {{ compliance.points_progress_percentage|floatformat:0 }}%
                                </p>
                                <p class="text-xs text-gray-500">progress</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <a href="{% url 'cpd:generate_report' %}?compliance_status=AT_RISK,NON_COMPLIANT" 
                       class="text-sm font-medium text-blue-600 hover:text-blue-700">
                        Generate at-risk report →
                    </a>
                </div>
            {% else %}
                <div class="text-center py-6">
                    <i class="bi bi-shield-check text-green-400 text-2xl mb-2"></i>
                    <p class="text-sm text-gray-600">All users are on track!</p>
                    <p class="text-xs text-gray-500">No users identified as at-risk</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Export and Actions -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-medium text-gray-900">Export & Actions</h3>
                <p class="text-sm text-gray-600">Generate reports and perform administrative actions</p>
            </div>
            <div class="flex items-center space-x-3">
                <a href="{% url 'cpd:generate_report' %}" 
                   class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    <i class="bi bi-file-earmark-text mr-2"></i>
                    Generate Report
                </a>
                <a href="{% url 'cpd:approval_queue' %}" 
                   class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                    <i class="bi bi-list-check mr-2"></i>
                    Review Queue
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Hidden data for charts -->
<script type="application/json" id="timeline-data">{{ timeline_data|safe }}</script>

<!-- Analytics JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Timeline data is available in the timeline-data script tag
    const timelineData = JSON.parse(document.getElementById('timeline-data').textContent);
    
    // Chart implementation would go here
    // Example: Chart.js, D3.js, or other charting library
    console.log('Timeline data loaded:', timelineData.length, 'data points');
    
    // You could integrate with Chart.js like this:
    // const ctx = document.getElementById('timeline-chart').getContext('2d');
    // new Chart(ctx, {
    //     type: 'line',
    //     data: {
    //         labels: timelineData.map(d => d.date),
    //         datasets: [{
    //             label: 'Daily Records',
    //             data: timelineData.map(d => d.records),
    //             borderColor: 'rgb(59, 130, 246)',
    //             tension: 0.1
    //         }]
    //     }
    // });
});
</script>
{% endblock %}